name: Deploy Truray Backend & Frontend to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Check for backend changes
        id: backend-changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -qE '^backend/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Backend files changed, will deploy"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No backend changes detected, skipping deployment"
          fi
      
      - name: Setup PHP
        if: steps.backend-changes.outputs.changed == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
      
      - name: Install Composer Dependencies
        if: steps.backend-changes.outputs.changed == 'true'
        run: |
          cd backend
          composer install --no-dev --optimize-autoloader --no-interaction
      
      - name: Create .env file
        if: steps.backend-changes.outputs.changed == 'true'
        run: |
          cd backend
          cat > .env << 'EOF'
          ${{ secrets.BACKEND_ENV }}
          EOF
      
      - name: Deploy Backend to Hostinger
        if: steps.backend-changes.outputs.changed == 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "backend/*"
          target: "/home/${{ secrets.SSH_USER }}/domains/orange-ferret-922211.hostingersite.com/public_html/"
          strip_components: 1
          overwrite: true
          
      - name: Setup Backend Permissions
        if: steps.backend-changes.outputs.changed == 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/${{ secrets.SSH_USER }}/domains/orange-ferret-922211.hostingersite.com/public_html
            
            find . -type d -exec chmod 755 {} \;
            find . -type f -exec chmod 644 {} \;
            
            chmod 600 .env
            
            mkdir -p storage/logs storage/uploads public/uploads
            chmod -R 775 storage public/uploads
            
            echo "Backend deployed successfully"

  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check for frontend changes
        id: frontend-changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -v '^backend/' | grep -q '.'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Frontend files changed, will deploy"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No frontend changes detected, skipping deployment"
          fi

      - name: Setup Node.js
        if: steps.frontend-changes.outputs.changed == 'true'
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        if: steps.frontend-changes.outputs.changed == 'true'
        run: |
          npm install
          npm install framer-motion --save

      - name: Create .env file
        if: steps.frontend-changes.outputs.changed == 'true'
        run: |
          cat > .env << 'EOF'
          ${{ secrets.FRONTEND_ENV }}
          EOF

      - name: Build Frontend
        if: steps.frontend-changes.outputs.changed == 'true'
        run: npm run build

      - name: Find and verify build directory
        if: steps.frontend-changes.outputs.changed == 'true'
        run: |
          echo "Checking for build directories..."
          if [ -d "build" ]; then
            echo "Found 'build' directory"
            ls -la build/
            echo "BUILD_DIR=build" >> $GITHUB_ENV
          elif [ -d "dist" ]; then
            echo "Found 'dist' directory"
            ls -la dist/
            echo "BUILD_DIR=dist" >> $GITHUB_ENV
          elif [ -d "out" ]; then
            echo "Found 'out' directory"
            ls -la out/
            echo "BUILD_DIR=out" >> $GITHUB_ENV
          else
            echo "No build directory found! Available directories:"
            ls -la
            exit 1
          fi

      - name: Deploy Frontend to Hostinger
        if: steps.frontend-changes.outputs.changed == 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "${{ env.BUILD_DIR }}/."
          target: "/home/${{ secrets.SSH_USER }}/domains/mediumturquoise-giraffe-679504.hostingersite.com/public_html/"
          strip_components: 1
          overwrite: true

      - name: Confirm Frontend Deployment
        if: steps.frontend-changes.outputs.changed == 'true'
        run: echo "Frontend deployed successfully!"